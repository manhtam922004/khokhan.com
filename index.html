<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Flashcard 1000 Từ Thông Dụng – Ảnh + Trắc nghiệm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0f172a; color:#e2e8f0; }
    .card-img-top { object-fit: cover; height: 320px; background:#111827; }
    .option-btn { text-align:left; }
    .option-btn.correct { border:2px solid #22c55e !important; }
    .option-btn.wrong { border:2px solid #ef4444 !important; }
    .faint { opacity:.75 }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .badge-pill { border-radius: 999px; }
    .link-lightish { color:#cbd5e1; }
    .link-lightish:hover { color:white; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg" style="background:#111827">
  <div class="container">
    <a class="navbar-brand text-light" href="#">Flashcard 1000 Từ</a>
    <div class="ms-auto d-flex gap-2">
      <button id="btnImport" class="btn btn-outline-light btn-sm">Import CSV/JSON</button>
      <button id="btnExport" class="btn btn-outline-light btn-sm">Export dữ liệu</button>
      <button id="btnReset"  class="btn btn-danger btn-sm">Xoá tiến độ</button>
    </div>
  </div>
</nav>

<main class="container py-4">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card shadow" style="background:#0b1220; border-color:#1f2937">
        <img id="imgWord" class="card-img-top" src="" alt="image" onerror="this.src=''; this.style.background='#111827';">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <span class="badge text-bg-secondary badge-pill">Câu: <span id="idxNow">0</span>/<span id="idxTotal">0</span></span>
              <span class="badge text-bg-dark badge-pill">Lặp chờ: <span id="qSize">0</span></span>
            </div>
            <small class="faint">Lần sai hiện tại: <span id="wrongThisRound" class="mono">0</span></small>
          </div>
          <h5 id="questionText" class="card-title mb-3">Nhìn ảnh và chọn đúng từ tiếng Anh</h5>
          <div id="options" class="d-grid gap-2"></div>
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
              <span class="badge text-bg-success">Đúng: <span id="statRight">0</span></span>
              <span class="badge text-bg-danger">Sai: <span id="statWrong">0</span></span>
            </div>
            <div class="d-flex gap-2">
              <button id="btnReveal" class="btn btn-outline-info btn-sm">Gợi ý/Hiện đáp án</button>
              <button id="btnSkip" class="btn btn-outline-warning btn-sm">Bỏ qua</button>
              <button id="btnNext" class="btn btn-primary btn-sm">Tiếp tục</button>
            </div>
          </div>
          <div id="feedback" class="mt-3"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow" style="background:#0b1220; border-color:#1f2937">
        <div class="card-body">
          <h5 class="mb-3">Cài đặt/Preset</h5>
          <div class="mb-3">
            <label class="form-label">Nguồn ảnh</label>
            <select id="imageSource" class="form-select form-select-sm">
              <option value="auto">Tự động (ưu tiên link có sẵn, nếu trống dùng Unsplash)</option>
              <option value="unsplash">Luôn dùng Unsplash (theo từ)</option>
              <option value="none">Không hiển thị ảnh (chỉ quiz chữ)</option>
            </select>
            <div class="form-text">Unsplash: <span class="faint">https://source.unsplash.com/600x400/?{word}</span></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Số đáp án mỗi câu</label>
            <input id="numChoices" type="number" class="form-control form-control-sm" min="4" max="6" value="4">
          </div>
          <div class="mb-3">
            <label class="form-label">Chế độ hàng đợi</label>
            <select id="queueMode" class="form-select form-select-sm">
              <option value="fifo">Chuẩn (đẩy cuối hàng)</option>
              <option value="spaced">Giãn cách nhẹ (rải đều hơn)</option>
            </select>
          </div>
          <div class="d-grid">
            <button id="btnStart" class="btn btn-success">Bắt đầu học</button>
          </div>
          <hr>
          <h6>Nhập nhanh 1 từ</h6>
          <div class="input-group input-group-sm mb-2">
            <input id="quickWord" class="form-control" placeholder="ví dụ: apple">
            <input id="quickImg" class="form-control" placeholder="link ảnh (có thể để trống)">
            <button id="btnAddQuick" class="btn btn-outline-light">Thêm</button>
          </div>
          <small class="faint">Tổng từ hiện có: <span id="wordCount">0</span></small>
          <hr>
          <details>
            <summary class="link-lightish">Hướng dẫn Import</summary>
            <div class="mt-2 small">
              <b>CSV</b>: <span class="mono">word,imageUrl</span><br>
              <b>JSON</b>: <span class="mono">[{"word":"apple","imageUrl":"..."}, ...]</span><br>
              Dữ liệu sẽ được gộp vào bộ từ hiện có và lưu vào trình duyệt.
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="background:#0b1220; color:#e2e8f0;">
      <div class="modal-header">
        <h5 class="modal-title">Import CSV/JSON</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="fileInput" type="file" class="form-control mb-3" accept=".csv,.json,text/csv,application/json">
        <textarea id="pasteInput" class="form-control mono" rows="10" placeholder="Dán nội dung CSV hoặc JSON vào đây (tuỳ chọn)"></textarea>
        <div class="form-text">Nếu chọn file, sẽ ưu tiên đọc file. Nếu không, sẽ đọc vùng dán ở trên.</div>
      </div>
      <div class="modal-footer">
        <button id="btnDoImport" class="btn btn-primary">Import</button>
      </div>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="background:#0b1220; color:#e2e8f0;">
      <div class="modal-header">
        <h5 class="modal-title">Export dữ liệu (JSON)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <textarea id="exportArea" class="form-control mono" rows="12" readonly></textarea>
      </div>
      <div class="modal-footer">
        <button id="btnCopyExport" class="btn btn-outline-light">Copy</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ===============================
   LocalStorage Keys
==================================*/
const LS_WORDS   = 'fc_words_v1';
const LS_PROG    = 'fc_progress_v1';
const LS_QUEUE   = 'fc_queue_v1';
const LS_SETTINGS= 'fc_settings_v1';

/* ===============================
   Utils
==================================*/
const $ = (sel)=>document.querySelector(sel);

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function sample(arr, k){
  const a = [...arr];
  shuffle(a);
  return a.slice(0,k);
}
function uid(){ return Math.random().toString(36).slice(2,10); }
function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function loadLS(key, def){ try { return JSON.parse(localStorage.getItem(key)) ?? def; } catch(e){ return def; } }

function unsplashUrl(word){
  const q = encodeURIComponent(word);
  return `https://source.unsplash.com/600x400/?${q}`;
}

/* ===============================
   Data Model
   word: { id, word, imageUrl? }
   progress: { [id]: {right: number, wrong: number, lastSeen: number } }
   queue: [id, id, ...]  // repetition queue
==================================*/
let words = loadLS(LS_WORDS, [
  // mẫu ban đầu – bạn hãy Import thêm 1000 từ
  { id: uid(), word: "apple",   imageUrl: "" },
  { id: uid(), word: "book",    imageUrl: "" },
  { id: uid(), word: "water",   imageUrl: "" },
  { id: uid(), word: "house",   imageUrl: "" },
  { id: uid(), word: "table",   imageUrl: "" },
  { id: uid(), word: "chair",   imageUrl: "" },
  { id: uid(), word: "street",  imageUrl: "" },
  { id: uid(), word: "window",  imageUrl: "" },
  { id: uid(), word: "door",    imageUrl: "" },
  { id: uid(), word: "coffee",  imageUrl: "" },
  { id: uid(), word: "music",   imageUrl: "" },
  { id: uid(), word: "school",  imageUrl: "" },
  { id: uid(), word: "teacher", imageUrl: "" },
  { id: uid(), word: "student", imageUrl: "" },
  { id: uid(), word: "river",   imageUrl: "" },
  { id: uid(), word: "sea",     imageUrl: "" },
  { id: uid(), word: "mountain",imageUrl: "" },
  { id: uid(), word: "sun",     imageUrl: "" },
  { id: uid(), word: "moon",    imageUrl: "" },
  { id: uid(), word: "car",     imageUrl: "" }
]);
let progress = loadLS(LS_PROG, {});
let queue    = loadLS(LS_QUEUE, []);
let settings = loadLS(LS_SETTINGS, { imageSource:'auto', numChoices:4, queueMode:'fifo' });

/* ===============================
   State (session)
==================================*/
let currentId = null;
let currentWrongThisRound = 0;
let answered = false;
let statsSession = { right:0, wrong:0 };
let idxCounter = 0;

/* ===============================
   UI Refs
==================================*/
const imgWord = $('#imgWord');
const questionText = $('#questionText');
const optionsBox = $('#options');
const feedback = $('#feedback');

const idxNow = $('#idxNow');
const idxTotal = $('#idxTotal');
const qSize = $('#qSize');
const wrongThisRound = $('#wrongThisRound');
const statRight = $('#statRight');
const statWrong = $('#statWrong');

const imageSource = $('#imageSource');
const numChoices = $('#numChoices');
const queueMode = $('#queueMode');

const btnStart = $('#btnStart');
const btnNext = $('#btnNext');
const btnSkip = $('#btnSkip');
const btnReveal = $('#btnReveal');

const btnImport = $('#btnImport');
const btnExport = $('#btnExport');
const btnReset = $('#btnReset');
const wordCount = $('#wordCount');

const quickWord = $('#quickWord');
const quickImg  = $('#quickImg');
const btnAddQuick = $('#btnAddQuick');

/* ===============================
   Init UI
==================================*/
function syncSettingsUI(){
  imageSource.value = settings.imageSource || 'auto';
  numChoices.value = settings.numChoices || 4;
  queueMode.value = settings.queueMode || 'fifo';
}
syncSettingsUI();
wordCount.textContent = words.length;

/* ===============================
   Queue Build / Draw Card
==================================*/
function ensureQueue(){
  // nếu queue rỗng, đưa toàn bộ id vào queue 1 lượt
  if(!queue || queue.length === 0){
     queue = words.map(w => w.id);
     shuffle(queue);
     saveLS(LS_QUEUE, queue);
  }
}

function getWordById(id){ return words.find(w => w.id === id) || null; }

function buildChoices(correctId, n){
  const pool = words.filter(w => w.id !== correctId);
  const distractors = sample(pool, Math.max(0, n-1));
  const choices = [ getWordById(correctId), ...distractors ];
  return shuffle(choices);
}

function imageForWord(w){
  const mode = settings.imageSource;
  if(mode === 'none') return '';
  if(mode === 'auto'){
    if(w.imageUrl && w.imageUrl.trim()) return w.imageUrl.trim();
    return unsplashUrl(w.word);
  }
  if(mode === 'unsplash'){
    return unsplashUrl(w.word);
  }
  return w.imageUrl || '';
}

function drawNextCard(){
  ensureQueue();
  if(queue.length === 0){
    questionText.textContent = "Hoàn thành hàng đợi! Nhấn Bắt đầu để học lại.";
    imgWord.src = "";
    optionsBox.innerHTML = "";
    return;
  }
  currentId = queue.shift(); // lấy đầu hàng
  saveLS(LS_QUEUE, queue);
  currentWrongThisRound = 0;
  answered = false;

  const w = getWordById(currentId);
  const imgUrl = imageForWord(w);
  if(imgUrl) { imgWord.src = imgUrl; imgWord.style.display='block'; }
  else { imgWord.src = ''; imgWord.style.display='none'; }

  questionText.innerHTML = `Chọn đúng từ cho hình ảnh: <b>${w.word}</b>`.replace(/<b>.*<\/b>/,''); 
  // Để tăng độ khó, không show từ – chỉ hình ảnh:
  questionText.textContent = "Nhìn ảnh và chọn đúng từ tiếng Anh";

  const nChoices = Math.max(4, Math.min(6, parseInt(numChoices.value||'4',10)));
  const choices = buildChoices(currentId, nChoices);

  optionsBox.innerHTML = "";
  choices.forEach(choice=>{
    const btn = document.createElement('button');
    btn.className = "btn btn-outline-light option-btn";
    btn.textContent = choice.word;
    btn.onclick = ()=>handleAnswer(choice.id === currentId, btn);
    optionsBox.appendChild(btn);
  });

  idxCounter += 1;
  updateHUD();
  feedback.innerHTML = "";
}

function scheduleRepeats(id, times){
  if(times <= 0) return;
  if(settings.queueMode === 'fifo'){
    // đẩy vào cuối
    for(let i=0;i<times;i++) queue.push(id);
  } else {
    // spaced: rải đều hơn – chèn cách nhau 3,5,7 vị trí
    const gaps = [3,5,7,9,11,13];
    for(let i=0;i<times;i++){
      const pos = Math.min(queue.length, gaps[i%gaps.length]);
      queue.splice(pos, 0, id);
    }
  }
  saveLS(LS_QUEUE, queue);
}

function updateProgress(id, isRight){
  const now = Date.now();
  if(!progress[id]) progress[id] = { right:0, wrong:0, lastSeen:0 };
  if(isRight) progress[id].right += 1; else progress[id].wrong += 1;
  progress[id].lastSeen = now;
  saveLS(LS_PROG, progress);
}

/* ===============================
   Answer Handling
==================================*/
function handleAnswer(correct, btnEl){
  if(answered) return;
  const buttons = optionsBox.querySelectorAll('.option-btn');
  const w = getWordById(currentId);

  if(correct){
    btnEl.classList.add('correct');
    // đánh dấu đáp án đúng
    buttons.forEach(b=>{
      if(b.textContent === w.word) b.classList.add('correct');
      b.disabled = true;
    });
    answered = true;
    updateProgress(currentId, true);
    statsSession.right += 1;

    // quy tắc lặp lại:
    // - đúng ngay lần đầu  => lặp 1 lần
    // - sai n lần trong vòng hiện tại => lặp n+1 lần
    const repeats = (currentWrongThisRound === 0) ? 1 : (currentWrongThisRound + 1);
    scheduleRepeats(currentId, repeats);

    feedback.innerHTML = `<div class="alert alert-success mt-2">Chính xác! Sẽ ôn lại từ này thêm <b>${repeats}</b> lần.</div>`;
    updateHUD();
  } else {
    btnEl.classList.add('wrong');
    btnEl.disabled = true;
    currentWrongThisRound += 1;
    updateProgress(currentId, false);
    statsSession.wrong += 1;
    feedback.innerHTML = `<div class="alert alert-danger mt-2">Chưa đúng. Hãy thử lại!</div>`;
    updateHUD(false);
  }
}

function revealAnswer(){
  if(!currentId) return;
  const w = getWordById(currentId);
  const buttons = optionsBox.querySelectorAll('.option-btn');
  buttons.forEach(b=>{
    if(b.textContent === w.word) b.classList.add('correct');
  });
}

function skipCard(){
  // Đẩy thẻ hiện tại xuống sau 1–2 vị trí để không kẹt
  const pushTimes = 1;
  scheduleRepeats(currentId, pushTimes);
  feedback.innerHTML = `<div class="alert alert-warning mt-2">Đã bỏ qua – thẻ sẽ xuất hiện lại ngay sau.</div>`;
  answered = true;
}

function nextCard(){
  drawNextCard();
}

/* ===============================
   HUD
==================================*/
function updateHUD(increaseSeen=true){
  idxNow.textContent = idxCounter;
  idxTotal.textContent = statsSession.right + statsSession.wrong;
  qSize.textContent = queue.length;
  wrongThisRound.textContent = currentWrongThisRound;
  statRight.textContent = statsSession.right;
  statWrong.textContent = statsSession.wrong;
  wordCount.textContent = words.length;
}

/* ===============================
   Import / Export / Reset
==================================*/
const importModal = new bootstrap.Modal(document.getElementById('importModal'));
const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));

btnImport.onclick = ()=> importModal.show();

$('#btnDoImport').onclick = async ()=>{
  try{
    const f = $('#fileInput').files[0];
    let text = "";
    if(f){
      text = await f.text();
    } else {
      text = $('#pasteInput').value.trim();
    }
    if(!text){ alert("Không có dữ liệu CSV/JSON."); return; }

    let incoming = [];
    // thử JSON trước
    try {
      const j = JSON.parse(text);
      if(Array.isArray(j)) incoming = j;
    } catch(e){
      // parse CSV
      incoming = parseCSV(text);
    }
    // normalize
    const toAdd = [];
    incoming.forEach(row=>{
      if(!row) return;
      if(typeof row === 'string'){
        if(row.trim()) toAdd.push({ word: row.trim(), imageUrl: "" });
      } else if(row.word){
        toAdd.push({ word: String(row.word).trim(), imageUrl: (row.imageUrl||"").trim() });
      }
    });
    // de-dup theo từ (case-insensitive)
    const existing = new Set(words.map(w=>w.word.toLowerCase()));
    const merged = [...words];
    toAdd.forEach(x=>{
      if(!x.word) return;
      const key = x.word.toLowerCase();
      if(!existing.has(key)){
        merged.push({ id: uid(), word: x.word, imageUrl: x.imageUrl||"" });
        existing.add(key);
      }
    });
    words = merged;
    saveLS(LS_WORDS, words);
    wordCount.textContent = words.length;
    importModal.hide();
    alert(`Đã nhập ${toAdd.length} mục. Tổng số từ: ${words.length}`);
  }catch(err){
    console.error(err);
    alert("Import lỗi. Hãy kiểm tra định dạng CSV/JSON.");
  }
};

function parseCSV(text){
  // đơn giản: tách dòng, tách dấu phẩy – hỗ trợ 2 cột: word,imageUrl
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return [];
  let hasHeader = false;
  if(/word/i.test(lines[0])) hasHeader = true;
  const rows = hasHeader ? lines.slice(1) : lines;
  return rows.map(l=>{
    const parts = l.split(',').map(x=>x.trim());
    return { word: parts[0] || "", imageUrl: parts[1] || "" };
  });
}

btnExport.onclick = ()=>{
  const payload = {
    words, progress, queue, settings
  };
  $('#exportArea').value = JSON.stringify(payload, null, 2);
  exportModal.show();
};
$('#btnCopyExport').onclick = ()=>{
  navigator.clipboard.writeText($('#exportArea').value);
};

btnReset.onclick = ()=>{
  if(confirm("Xoá toàn bộ tiến độ & hàng đợi? (Không xoá danh sách từ)")){
    progress = {};
    queue = [];
    statsSession = { right:0, wrong:0 };
    idxCounter = 0;
    saveLS(LS_PROG, progress);
    saveLS(LS_QUEUE, queue);
    updateHUD();
    alert("Đã xoá tiến độ.");
  }
};

/* ===============================
   Quick Add
==================================*/
btnAddQuick.onclick = ()=>{
  const w = quickWord.value.trim();
  const img = quickImg.value.trim();
  if(!w){ alert("Nhập từ!"); return; }
  if(words.some(x=>x.word.toLowerCase()===w.toLowerCase())){
    alert("Từ đã tồn tại.");
    return;
  }
  words.push({ id: uid(), word: w, imageUrl: img });
  saveLS(LS_WORDS, words);
  quickWord.value = ""; quickImg.value = "";
  wordCount.textContent = words.length;
};

/* ===============================
   Settings Save
==================================*/
imageSource.onchange = ()=>{
  settings.imageSource = imageSource.value;
  saveLS(LS_SETTINGS, settings);
};
numChoices.onchange = ()=>{
  let v = parseInt(numChoices.value||'4',10);
  v = Math.max(4, Math.min(6, v));
  settings.numChoices = v;
  saveLS(LS_SETTINGS, settings);
};
queueMode.onchange = ()=>{
  settings.queueMode = queueMode.value;
  saveLS(LS_SETTINGS, settings);
};

/* ===============================
   Controls
==================================*/
btnStart.onclick = ()=>{
  // tạo queue nếu chưa có
  ensureQueue();
  statsSession = { right:0, wrong:0 };
  idxCounter = 0;
  drawNextCard();
};

btnNext.onclick = ()=> nextCard();
btnSkip.onclick = ()=> { skipCard(); };
btnReveal.onclick = ()=> revealAnswer();

/* ===============================
   Load last state
==================================*/
updateHUD();

</script>
</body>
</html>
